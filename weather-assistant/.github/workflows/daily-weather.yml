name: –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã

on:
  schedule:
    # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 7:00 —É—Ç—Ä–∞
    - cron: '0 7 * * *'
  workflow_dispatch: # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  push: # –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

jobs:
  get-weather:
    runs-on: ubuntu-latest
    steps:
      - name: –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        uses: actions/checkout@v4

      - name: –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–≥–æ–¥—É
        id: current_weather
        env:
          API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
          CITY_ID: ${{ secrets.CITY_ID }}
        run: |
          # –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫ OpenWeather API
          RESPONSE=$(curl -s "https://api.openweathermap.org/data/2.5/weather?id=$CITY_ID&appid=$API_KEY&units=metric&lang=ru")
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ
          TEMP=$(echo $RESPONSE | jq -r '.main.temp')
          FEELS_LIKE=$(echo $RESPONSE | jq -r '.main.feels_like')
          HUMIDITY=$(echo $RESPONSE | jq -r '.main.humidity')
          WIND_SPEED=$(echo $RESPONSE | jq -r '.wind.speed')
          DESCRIPTION=$(echo $RESPONSE | jq -r '.weather[0].description')
          MAIN_WEATHER=$(echo $RESPONSE | jq -r '.weather[0].main')
          PRESSURE=$(echo $RESPONSE | jq -r '.main.pressure')
          
          # –ü–æ–ª—É—á–∞–µ–º –≥–æ—Ä–æ–¥ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
          CITY_NAME=$(jq -r '.city.name' weather_config.json)
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ outputs
          echo "city=$CITY_NAME" >> $GITHUB_OUTPUT
          echo "temp=$TEMP" >> $GITHUB_OUTPUT
          echo "feels_like=$FEELS_LIKE" >> $GITHUB_OUTPUT
          echo "humidity=$HUMIDITY" >> $GITHUB_OUTPUT
          echo "wind_speed=$WIND_SPEED" >> $GITHUB_OUTPUT
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "main_weather=$MAIN_WEATHER" >> $GITHUB_OUTPUT
          echo "pressure=$PRESSURE" >> $GITHUB_OUTPUT
          
          echo "–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–æ–≥–æ–¥—ã –¥–ª—è $CITY_NAME"

      - name: –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –¥–µ–Ω—å
        id: forecast
        env:
          API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
          CITY_ID: ${{ secrets.CITY_ID }}
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 5 –¥–Ω–µ–π
          RESPONSE=$(curl -s "https://api.openweathermap.org/data/2.5/forecast?id=$CITY_ID&appid=$API_KEY&units=metric&lang=ru&cnt=8")
          
          # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
          TODAY_TEMP_MIN=$(echo $RESPONSE | jq -r '.list[].main.temp_min' | sort -n | head -1)
          TODAY_TEMP_MAX=$(echo $RESPONSE | jq -r '.list[].main.temp_max' | sort -rn | head -1)
          
          # –ò—â–µ–º –æ—Å–∞–¥–∫–∏
          HAS_RAIN=$(echo $RESPONSE | jq -r '.list[].weather[0].main' | grep -i "rain" | head -1 || true)
          HAS_SNOW=$(echo $RESPONSE | jq -r '.list[].weather[0].main' | grep -i "snow" | head -1 || true)
          
          echo "temp_min=$TODAY_TEMP_MIN" >> $GITHUB_OUTPUT
          echo "temp_max=$TODAY_TEMP_MAX" >> $GITHUB_OUTPUT
          echo "has_rain=$HAS_RAIN" >> $GITHUB_OUTPUT
          echo "has_snow=$HAS_SNOW" >> $GITHUB_OUTPUT

      - name: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        id: recommendations
        env:
          CURRENT_TEMP: ${{ steps.current_weather.outputs.temp }}
        run: |
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø–æ–≥–æ–¥—ã –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
          TEMP_NUM=$(echo $CURRENT_TEMP | cut -d. -f1)
          
          if [ $TEMP_NUM -ge 25 ]; then
            echo "temp_category=hot" >> $GITHUB_OUTPUT
            echo "clothing=–æ—á–µ–Ω—å –∂–∞—Ä–∫–æ" >> $GITHUB_OUTPUT
          elif [ $TEMP_NUM -ge 18 ]; then
            echo "temp_category=warm" >> $GITHUB_OUTPUT
            echo "clothing=—Ç–µ–ø–ª–æ" >> $GITHUB_OUTPUT
          elif [ $TEMP_NUM -ge 10 ]; then
            echo "temp_category=cool" >> $GITHUB_OUTPUT
            echo "clothing=–ø—Ä–æ—Ö–ª–∞–¥–Ω–æ" >> $GITHUB_OUTPUT
          elif [ $TEMP_NUM -ge 0 ]; then
            echo "temp_category=cold" >> $GITHUB_OUTPUT
            echo "clothing=—Ö–æ–ª–æ–¥–Ω–æ" >> $GITHUB_OUTPUT
          else
            echo "temp_category=freezing" >> $GITHUB_OUTPUT
            echo "clothing=–æ—á–µ–Ω—å —Ö–æ–ª–æ–¥–Ω–æ" >> $GITHUB_OUTPUT
          fi
          
          # –í—ã–±–∏—Ä–∞–µ–º —ç–º–æ–¥–∑–∏ –ø–æ–≥–æ–¥—ã
          WEATHER_TYPE="${{ steps.current_weather.outputs.main_weather }}"
          case $WEATHER_TYPE in
            "Clear")
              echo "emoji=‚òÄÔ∏è" >> $GITHUB_OUTPUT
              echo "activity_type=sunny" >> $GITHUB_OUTPUT
              ;;
            "Clouds")
              echo "emoji=‚òÅÔ∏è" >> $GITHUB_OUTPUT
              echo "activity_type=cloudy" >> $GITHUB_OUTPUT
              ;;
            "Rain" | "Drizzle")
              echo "emoji=üåßÔ∏è" >> $GITHUB_OUTPUT
              echo "activity_type=rainy" >> $GITHUB_OUTPUT
              ;;
            "Snow")
              echo "emoji=‚ùÑÔ∏è" >> $GITHUB_OUTPUT
              echo "activity_type=snowy" >> $GITHUB_OUTPUT
              ;;
            "Thunderstorm")
              echo "emoji=‚õàÔ∏è" >> $GITHUB_OUTPUT
              echo "activity_type=rainy" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "emoji=‚òÅÔ∏è" >> $GITHUB_OUTPUT
              echo "activity_type=cloudy" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: –ü–æ–ª—É—á–∞–µ–º –æ–¥–µ–∂–¥—É –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        id: get_advice
        run: |
          # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–¥–µ–∂–¥–µ
          CATEGORY="${{ steps.recommendations.outputs.temp_category }}"
          CLOTHING=$(jq -r ".clothing_recommendations.$CATEGORY[]" weather_config.json | head -5)
          
          # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º
          CLOTHING_LIST=""
          while IFS= read -r item; do
            CLOTHING_LIST+="‚Ä¢ $item\n"
          done <<< "$CLOTHING"
          
          echo "clothing_list<<EOF" >> $GITHUB_OUTPUT
          echo "$CLOTHING_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
          ACTIVITY_TYPE="${{ steps.recommendations.outputs.activity_type }}"
          ACTIVITIES=$(jq -r ".activities.$ACTIVITY_TYPE[]" weather_config.json | head -3)
          
          ACTIVITY_LIST=""
          while IFS= read -r item; do
            ACTIVITY_LIST+="‚Ä¢ $item\n"
          done <<< "$ACTIVITIES"
          
          echo "activity_list<<EOF" >> $GITHUB_OUTPUT
          echo "$ACTIVITY_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ${{ steps.recommendations.outputs.emoji }} *–ü–û–ì–û–î–ê –°–ï–ì–û–î–ù–Ø –≤ ${{ steps.current_weather.outputs.city }}*
            
            *–î–∞—Ç–∞:* $(date +"%d.%m.%Y")
            *–í—Ä–µ–º—è:* $(date +"%H:%M")
            
            *–¢–µ–∫—É—â–∞—è –ø–æ–≥–æ–¥–∞:*
            ‚Ä¢ –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${{ steps.current_weather.outputs.temp }}¬∞C
            ‚Ä¢ –û—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫: ${{ steps.current_weather.outputs.feels_like }}¬∞C
            ‚Ä¢ –û–ø–∏—Å–∞–Ω–∏–µ: ${{ steps.current_weather.outputs.description }}
            ‚Ä¢ –í–ª–∞–∂–Ω–æ—Å—Ç—å: ${{ steps.current_weather.outputs.humidity }}%
            ‚Ä¢ –í–µ—Ç–µ—Ä: ${{ steps.current_weather.outputs.wind_speed }} –º/—Å
            ‚Ä¢ –î–∞–≤–ª–µ–Ω–∏–µ: ${{ steps.current_weather.outputs.pressure }} –≥–ü–∞
            
            *–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –¥–µ–Ω—å:*
            ‚Ä¢ –ú–∏–Ω–∏–º—É–º: ${{ steps.forecast.outputs.temp_min }}¬∞C
            ‚Ä¢ –ú–∞–∫—Å–∏–º—É–º: ${{ steps.forecast.outputs.temp_max }}¬∞C
            ${{ steps.forecast.outputs.has_rain != '' && '‚Ä¢ ‚õàÔ∏è –û–∂–∏–¥–∞–µ—Ç—Å—è –¥–æ–∂–¥—å' || '' }}
            ${{ steps.forecast.outputs.has_snow != '' && '‚Ä¢ ‚ùÑÔ∏è –û–∂–∏–¥–∞–µ—Ç—Å—è —Å–Ω–µ–≥' || '' }}
            
            *–ß—Ç–æ –Ω–∞–¥–µ—Ç—å (${{ steps.recommendations.outputs.clothing }}):*
            ${{ steps.get_advice.outputs.clothing_list }}
            
            *–ß–µ–º –∑–∞–Ω—è—Ç—å—Å—è —Å–µ–≥–æ–¥–Ω—è:*
            ${{ steps.get_advice.outputs.activity_list }}
            
            *–°–æ–≤–µ—Ç:* –ù–µ –∑–∞–±—É–¥—å—Ç–µ –≤–∑—è—Ç—å –∑–æ–Ω—Ç, –µ—Å–ª–∏ –æ–∂–∏–¥–∞–µ—Ç—Å—è –¥–æ–∂–¥—å!
            
            –•–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è! üåü
          parse_mode: markdown

      - name: –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
        run: |
          # –ß–∏—Ç–∞–µ–º —Ç–µ–∫—É—â—É—é –∏—Å—Ç–æ—Ä–∏—é
          if [ -f "weather_history.json" ]; then
            jq '.' weather_history.json > history_temp.json
          else
            echo '{"last_update": "", "history": []}' > history_temp.json
          fi
          
          # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
          jq --arg date "$(date +"%Y-%m-%d %H:%M:%S")" \
             --arg temp "${{ steps.current_weather.outputs.temp }}" \
             --arg desc "${{ steps.current_weather.outputs.description }}" \
             '.last_update = $date | .history += [{"date": $date, "temperature": $temp, "description": $desc}] | .history = .history[-7:]' \
             history_temp.json > weather_history.json
          
          # –ö–æ–º–º–∏—Ç–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          git add weather_history.json
          git commit -m "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–≥–æ–¥—ã $(date +"%d.%m.%Y")" || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
          git push || echo "–ù–µ—á–µ–≥–æ –ø—É—à–∏—Ç—å"
          rm history_temp.json