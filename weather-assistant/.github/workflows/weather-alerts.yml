name: –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ –ø–æ–≥–æ–¥–Ω—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

on:
  schedule:
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 3 —á–∞—Å–∞
    - cron: '0 */3 * * *'
  workflow_dispatch:

jobs:
  check-alerts:
    runs-on: ubuntu-latest
    steps:
      - name: –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–ø–∞—Å–Ω—É—é –ø–æ–≥–æ–¥—É
        id: check_danger
        env:
          API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
          CITY_ID: ${{ secrets.CITY_ID }}
        run: |
          # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–≥–æ–¥—É
          RESPONSE=$(curl -s "https://api.openweathermap.org/data/2.5/weather?id=$CITY_ID&appid=$API_KEY&units=metric&lang=ru")
          
          TEMP=$(echo $RESPONSE | jq -r '.main.temp')
          WIND_SPEED=$(echo $RESPONSE | jq -r '.wind.speed')
          MAIN_WEATHER=$(echo $RESPONSE | jq -r '.weather[0].main')
          DESCRIPTION=$(echo $RESPONSE | jq -r '.weather[0].description')
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–ø–∞—Å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
          ALERT=""
          
          if (( $(echo "$TEMP >= 35" | bc -l) )); then
            ALERT+="*–ê–Ω–æ–º–∞–ª—å–Ω–∞—è –∂–∞—Ä–∞!* üî•\n–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${TEMP}¬∞C\n\n"
            echo "has_alert=true" >> $GITHUB_OUTPUT
          fi
          
          if (( $(echo "$TEMP <= -20" | bc -l) )); then
            ALERT+="*–°–∏–ª—å–Ω—ã–π –º–æ—Ä–æ–∑!* ‚ùÑÔ∏è\n–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${TEMP}¬∞C\n\n"
            echo "has_alert=true" >> $GITHUB_OUTPUT
          fi
          
          if (( $(echo "$WIND_SPEED >= 15" | bc -l) )); then
            ALERT+="*–°–∏–ª—å–Ω—ã–π –≤–µ—Ç–µ—Ä!* üí®\n–°–∫–æ—Ä–æ—Å—Ç—å: ${WIND_SPEED} –º/—Å\n\n"
            echo "has_alert=true" >> $GITHUB_OUTPUT
          fi
          
          if [[ "$MAIN_WEATHER" == "Thunderstorm" ]]; then
            ALERT+="*–ì—Ä–æ–∑–∞!* ‚õàÔ∏è\n$DESCRIPTION\n\n"
            echo "has_alert=true" >> $GITHUB_OUTPUT
          fi
          
          if [[ "$MAIN_WEATHER" == "Snow" ]] && (( $(echo "$TEMP <= -10" | bc -l) )); then
            ALERT+="*–°–∏–ª—å–Ω—ã–π —Å–Ω–µ–≥–æ–ø–∞–¥!* üö®\n$DESCRIPTION\n\n"
            echo "has_alert=true" >> $GITHUB_OUTPUT
          fi
          
          echo "alert_message<<EOF" >> $GITHUB_OUTPUT
          echo "$ALERT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
          if [ -z "$ALERT" ]; then
            echo "has_alert=false" >> $GITHUB_OUTPUT
          fi

      - name: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
        if: steps.check_danger.outputs.has_alert == 'true'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            *–ü–û–ì–û–î–ù–û–ï –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï!* üö®
            
            ${{ steps.check_danger.outputs.alert_message }}
            
            *–í–æ–∑–º–æ–∂–Ω–æ:*
            ‚Ä¢ –û—Å—Ç–∞–≤–∞–π—Ç–µ—Å—å –¥–æ–º–∞, –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ
            ‚Ä¢ –û–¥–µ–Ω—å—Ç–µ—Å—å –ø–æ –ø–æ–≥–æ–¥–µ
            ‚Ä¢ –ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã –Ω–∞ –¥–æ—Ä–æ–≥–∞—Ö
            ‚Ä¢ –°–ª–µ–¥–∏—Ç–µ –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏
            
            *–ì–æ—Ä–æ–¥:* $(jq -r '.city.name' weather_config.json)
            *–í—Ä–µ–º—è:* $(date +"%H:%M")
            
            *–ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã!* üôè
          parse_mode: markdown

      - name: –°–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –≤—Å—ë —Å–ø–æ–∫–æ–π–Ω–æ
        if: steps.check_danger.outputs.has_alert == 'false' && github.event_name == 'workflow_dispatch'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            *–í–°–Å –°–ü–û–ö–û–ô–ù–û* ‚úÖ
            
            –ü–æ–≥–æ–¥–Ω—ã—Ö –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –Ω–µ—Ç.
            –¢–µ–∫—É—â–∏–µ —É—Å–ª–æ–≤–∏—è –±–µ–∑–æ–ø–∞—Å–Ω—ã.
            –ú–æ–∂–µ—Ç–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–∏ –¥–µ–ª–∞!
            
            *–ì–æ—Ä–æ–¥:* $(jq -r '.city.name' weather_config.json)
            *–í—Ä–µ–º—è:* $(date +"%H:%M")
          parse_mode: markdown