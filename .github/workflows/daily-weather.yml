name: –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã

on:
  schedule:
    - cron: '0 7 * * *'  # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 7 —É—Ç—Ä–∞
  workflow_dispatch:

jobs:
  get-weather:
    runs-on: ubuntu-latest
    steps:
      - name: –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        uses: actions/checkout@v4

      - name: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É—Ç–∏–ª–∏—Ç—ã
        run: sudo apt-get update && sudo apt-get install -y jq bc

      - name: –ü–æ–ª—É—á–∞–µ–º –ø–æ–≥–æ–¥—É
        id: weather
        env:
          VC_API_KEY: ${{ secrets.VC_API_KEY }}
        run: |
          # –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫ Visual Crossing API
          RESPONSE=$(curl -s "https://weather.visualcrossing.com/VisualCrossingWebServices/rest/services/timeline/kazan?unitGroup=metric&include=current&key=$VC_API_KEY&contentType=json&lang=ru")
          
          # –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ –∏–∑ JSON
          TEMP=$(echo "$RESPONSE" | jq -r '.currentConditions.temp')
          FEELS_LIKE=$(echo "$RESPONSE" | jq -r '.currentConditions.feelslike')
          HUMIDITY=$(echo "$RESPONSE" | jq -r '.currentConditions.humidity')
          WIND_SPEED=$(echo "$RESPONSE" | jq -r '.currentConditions.windspeed')
          CONDITIONS=$(echo "$RESPONSE" | jq -r '.currentConditions.conditions')
          PRESSURE=$(echo "$RESPONSE" | jq -r '.currentConditions.pressure // "N/A"')
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é –ø–æ –æ–¥–µ–∂–¥–µ
          if (( $(echo "$TEMP >= 25" | bc -l) )); then
            CLOTHING="–æ—á–µ–Ω—å –∂–∞—Ä–∫–æ"
          elif (( $(echo "$TEMP >= 18" | bc -l) )); then
            CLOTHING="—Ç–µ–ø–ª–æ"
          elif (( $(echo "$TEMP >= 10" | bc -l) )); then
            CLOTHING="–ø—Ä–æ—Ö–ª–∞–¥–Ω–æ"
          elif (( $(echo "$TEMP >= 0" | bc -l) )); then
            CLOTHING="—Ö–æ–ª–æ–¥–Ω–æ"
          else
            CLOTHING="–æ—á–µ–Ω—å —Ö–æ–ª–æ–¥–Ω–æ"
          fi
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —ç–º–æ–¥–∑–∏ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
          case "$CONDITIONS" in
            *Clear*|*Sunny*)
              EMOJI="‚òÄÔ∏è"
              ACTIVITY="–ø—Ä–æ–≥—É–ª–∫–∞ –≤ –ø–∞—Ä–∫–µ, –ø–∏–∫–Ω–∏–∫, –≤–µ–ª–æ—Å–∏–ø–µ–¥–Ω–∞—è –ø—Ä–æ–≥—É–ª–∫–∞"
              ;;
            *Cloud*)
              EMOJI="‚òÅÔ∏è"
              ACTIVITY="–ø–æ—Å–µ—â–µ–Ω–∏–µ –º—É–∑–µ—è, —á—Ç–µ–Ω–∏–µ –≤ –∫–∞—Ñ–µ, —à–æ–ø–ø–∏–Ω–≥"
              ;;
            *Rain*|*Drizzle*)
              EMOJI="üåßÔ∏è"
              ACTIVITY="–¥–æ–º–∞—à–Ω–∏–π –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä, –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ –≤—ã–ø–µ—á–∫–∏, –Ω–∞—Å—Ç–æ–ª—å–Ω—ã–µ –∏–≥—Ä—ã"
              ;;
            *Snow*)
              EMOJI="‚ùÑÔ∏è"
              ACTIVITY="–∫–∞—Ç–∞–Ω–∏–µ –Ω–∞ —Å–∞–Ω–∫–∞—Ö, –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–Ω–µ–≥–æ–≤–∏–∫–∞, –≥–æ—Ä—è—á–∏–π —à–æ–∫–æ–ª–∞–¥"
              ;;
            *)
              EMOJI="üå§Ô∏è"
              ACTIVITY="–∑–∞–Ω—è—Ç–∏—è –¥–æ–º–∞, –ø–æ—Å–µ—â–µ–Ω–∏–µ –±–∞—Å—Å–µ–π–Ω–∞, —Ñ–∏—Ç–Ω–µ—Å-–∑–∞–ª"
              ;;
          esac
          
          # –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—É –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
          CURRENT_DATE=$(date +"%Y-%m-%d")
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–æ–≤
          echo "temp=$TEMP" >> $GITHUB_OUTPUT
          echo "feels_like=$FEELS_LIKE" >> $GITHUB_OUTPUT
          echo "humidity=$HUMIDITY" >> $GITHUB_OUTPUT
          echo "wind_speed=$WIND_SPEED" >> $GITHUB_OUTPUT
          echo "conditions=$CONDITIONS" >> $GITHUB_OUTPUT
          echo "pressure=$PRESSURE" >> $GITHUB_OUTPUT
          echo "clothing=$CLOTHING" >> $GITHUB_OUTPUT
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT
          echo "activity=$ACTIVITY" >> $GITHUB_OUTPUT
          echo "date=$CURRENT_DATE" >> $GITHUB_OUTPUT

      - name: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ${{ steps.weather.outputs.emoji }} –ü–û–ì–û–î–ê –í –ö–ê–ó–ê–ù–ò

            –¢–µ–∫—É—â–∞—è –ø–æ–≥–æ–¥–∞:
            ‚Ä¢ –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${{ steps.weather.outputs.temp }}¬∞C
            ‚Ä¢ –û—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫: ${{ steps.weather.outputs.feels_like }}¬∞C
            ‚Ä¢ –£—Å–ª–æ–≤–∏—è: ${{ steps.weather.outputs.conditions }}
            ‚Ä¢ –í–ª–∞–∂–Ω–æ—Å—Ç—å: ${{ steps.weather.outputs.humidity }}%
            ‚Ä¢ –í–µ—Ç–µ—Ä: ${{ steps.weather.outputs.wind_speed }} –º/—Å
            ‚Ä¢ –î–∞–≤–ª–µ–Ω–∏–µ: ${{ steps.weather.outputs.pressure }} –≥–ü–∞

            –ß—Ç–æ –Ω–∞–¥–µ—Ç—å (${{ steps.weather.outputs.clothing }}):
            ‚Ä¢ –§—É—Ç–±–æ–ª–∫–∞/—Å–≤–∏—Ç–µ—Ä (–ø–æ –ø–æ–≥–æ–¥–µ)
            ‚Ä¢ –ü–æ–¥—Ö–æ–¥—è—â–∞—è –≤–µ—Ä—Ö–Ω—è—è –æ–¥–µ–∂–¥–∞
            ‚Ä¢ –£–¥–æ–±–Ω–∞—è –æ–±—É–≤—å

            –ß–µ–º –∑–∞–Ω—è—Ç—å—Å—è —Å–µ–≥–æ–¥–Ω—è:
            ‚Ä¢ ${{ steps.weather.outputs.activity }}

            –°–æ–≤–µ—Ç: –°–ª–µ–¥–∏—Ç–µ –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –ø–æ–≥–æ–¥—ã –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è!

            ‚ö° –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞:
            ‚Ä¢ /weather - –¢–µ–∫—É—â–∞—è –ø–æ–≥–æ–¥–∞
            ‚Ä¢ /alerts - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
            ‚Ä¢ /report - –ù–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
            ‚Ä¢ /hourly - –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –µ–∂–µ—á–∞—Å–Ω—ã–µ
            ‚Ä¢ /stop - –û—Ç–ø–∏—Å–∞—Ç—å—Å—è –æ—Ç —Ä–∞—Å—Å—ã–ª–∫–∏

            –ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å –æ–¥–Ω—É –∏–∑ —ç—Ç–∏—Ö –∫–æ–º–∞–Ω–¥ –±–æ—Ç—É!

            –•–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è! üåü
          parse_mode: HTML

      - name: –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
        run: |
          # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
          TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")
          ENTRY='{"date":"'"$TIMESTAMP"'","temp":"'"${{ steps.weather.outputs.temp }}"'","conditions":"'"${{ steps.weather.outputs.conditions }}"'"}'
          
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å –∑–∞–ø–∏—Å—å—é
          echo "$ENTRY" > temp_entry.json
          
          # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª –∏—Å—Ç–æ—Ä–∏–∏
          if [ -f "weather_history.json" ]; then
            # –§–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
            jq '.history += [input]' weather_history.json temp_entry.json > temp.json
            mv temp.json weather_history.json
          else
            # –§–∞–π–ª–∞ –Ω–µ—Ç - —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
            echo '{"history":[]}' | jq '.history += [input]' - temp_entry.json > weather_history.json
          fi
          
          # –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π (168 —á–∞—Å–æ–≤)
          jq '.history = .history[-7:]' weather_history.json > temp.json
          mv temp.json weather_history.json
          
          # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
          rm temp_entry.json
          
          # –ö–æ–º–º–∏—Ç–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          git add weather_history.json
          git commit -m "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–≥–æ–¥—ã ${{ steps.weather.outputs.date }}" || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          git push || echo "–ù–µ—á–µ–≥–æ –ø—É—à–∏—Ç—å"
