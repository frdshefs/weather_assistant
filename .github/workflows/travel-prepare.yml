name: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ø–æ–µ–∑–¥–∫–µ

on:
  schedule:
    # –ó–∞ 3 –¥–Ω—è –¥–æ –ø–æ–µ–∑–¥–∫–∏ (–ø—Ä–∏–º–µ—Ä - –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 6 —É—Ç—Ä–∞)
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      travel_date:
        description: '–î–∞—Ç–∞ –ø–æ–µ–∑–¥–∫–∏ (–ì–ì–ì–ì-–ú–ú-–î–î)'
        required: true
        type: string
        default: '2024-02-01'
      destination:
        description: '–ü—É–Ω–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è'
        required: true
        type: string
        default: '–∫–∞–∑–∞–Ω—å'

jobs:
  countdown:
    runs-on: ubuntu-latest
    steps:
      - name: –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –æ—Å—Ç–∞–ª–æ—Å—å
        id: days_left
        run: |
          TRAVEL_DATE="${{ github.event.inputs.travel_date }}"
          TODAY=$(date +%s)
          TRAVEL=$(date -d "$TRAVEL_DATE" +%s 2>/dev/null || date -d "${TRAVEL_DATE}T00:00:00" +%s)
          
          # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω–∏—Ü—É –≤ –¥–Ω—è—Ö
          SECONDS_LEFT=$((TRAVEL - TODAY))
          DAYS_LEFT=$((SECONDS_LEFT / 86400))
          
          # –ï—Å–ª–∏ –¥–∞—Ç–∞ —É–∂–µ –ø—Ä–æ—à–ª–∞
          if [ $DAYS_LEFT -lt 0 ]; then
            DAYS_LEFT=0
          fi
          
          echo "days_left=$DAYS_LEFT" >> $GITHUB_OUTPUT
          echo "travel_date=$TRAVEL_DATE" >> $GITHUB_OUTPUT
          
          # –ü–æ–ª—É—á–∞–µ–º –ø–æ–≥–æ–¥—É –¥–ª—è –ø—É–Ω–∫—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
          echo "destination=${{ github.event.inputs.destination }}" >> $GITHUB_OUTPUT

      - name: –ü–æ–ª—É—á–∞–µ–º –ø–æ–≥–æ–¥—É –≤ –ø—É–Ω–∫—Ç–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
        if: steps.days_left.outputs.days_left <= 7
        id: destination_weather
        env:
          VC_API_KEY: ${{ secrets.VC_API_KEY }}
        run: |
          DESTINATION="${{ github.event.inputs.destination }}"
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º Visual Crossing API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–≥–æ–¥—ã
          RESPONSE=$(curl -s "https://weather.visualcrossing.com/VisualCrossingWebServices/rest/services/timeline/$DESTINATION?unitGroup=metric&include=current&key=$VC_API_KEY&contentType=json&lang=ru")
          
          TEMP=$(echo "$RESPONSE" | jq -r '.currentConditions.temp')
          CONDITIONS=$(echo "$RESPONSE" | jq -r '.currentConditions.conditions')
          HUMIDITY=$(echo "$RESPONSE" | jq -r '.currentConditions.humidity')
          
          echo "dest_temp=$TEMP" >> $GITHUB_OUTPUT
          echo "dest_conditions=$CONDITIONS" >> $GITHUB_OUTPUT
          echo "dest_humidity=$HUMIDITY" >> $GITHUB_OUTPUT

      - name: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —á–µ–∫–ª–∏—Å—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏
        id: checklist
        run: |
          DAYS_LEFT=${{ steps.days_left.outputs.days_left }}
          DESTINATION="${{ github.event.inputs.destination }}"
          
          # –†–∞–∑–Ω—ã–π —á–µ–∫–ª–∏—Å—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–Ω–µ–π
          CHECKLIST=""
          
          if [ $DAYS_LEFT -le 1 ]; then
            CHECKLIST+="*–ó–ê–í–¢–†–ê –ï–î–ï–ú!*\n\n"
            CHECKLIST+="‚Ä¢ –°–æ–±—Ä–∞—Ç—å –≤–µ—â–∏\n"
            CHECKLIST+="‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã\n"
            CHECKLIST+="‚Ä¢ –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å –±–∏–ª–µ—Ç—ã\n"
            CHECKLIST+="‚Ä¢ –ó–∞—Ä—è–¥–∏—Ç—å –≥–∞–¥–∂–µ—Ç—ã\n"
            CHECKLIST+="‚Ä¢ –í–∑—è—Ç—å –∑–∞—Ä—è–¥–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞\n"
            CHECKLIST+="‚Ä¢ –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –µ–¥—É –≤ –¥–æ—Ä–æ–≥—É\n"
          elif [ $DAYS_LEFT -le 3 ]; then
            CHECKLIST+="*–û—Å—Ç–∞–ª–æ—Å—å 3 –¥–Ω—è*\n\n"
            CHECKLIST+="‚Ä¢ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –±—Ä–æ–Ω—å –æ—Ç–µ–ª—è\n"
            CHECKLIST+="‚Ä¢ –û–±–º–µ–Ω—è—Ç—å –≤–∞–ª—é—Ç—É\n"
            CHECKLIST+="‚Ä¢ –°–∫–∞—á–∞—Ç—å –æ—Ñ—Ñ–ª–∞–π–Ω –∫–∞—Ä—Ç—ã\n"
            CHECKLIST+="‚Ä¢ –°–æ–±—Ä–∞—Ç—å –∞–ø—Ç–µ—á–∫—É\n"
            CHECKLIST+="‚Ä¢ –ù–∞—á–∞—Ç—å —Å–æ–±–∏—Ä–∞—Ç—å –≤–µ—â–∏\n"
            CHECKLIST+="‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã –≤ $DESTINATION\n"
          elif [ $DAYS_LEFT -le 7 ]; then
            CHECKLIST+="*–û—Å—Ç–∞–ª–∞—Å—å –Ω–µ–¥–µ–ª—è*\n\n"
            CHECKLIST+="‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –±–∏–ª–µ—Ç–æ–≤\n"
            CHECKLIST+="‚Ä¢ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è\n"
            CHECKLIST+="‚Ä¢ –°–æ—Å—Ç–∞–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤–µ—â–µ–π\n"
            CHECKLIST+="‚Ä¢ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –±—é–¥–∂–µ—Ç\n"
            CHECKLIST+="‚Ä¢ –ò–∑—É—á–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç\n"
            CHECKLIST+="‚Ä¢ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–≥–æ–¥—É –≤ $DESTINATION\n"
          elif [ $DAYS_LEFT -le 14 ]; then
            CHECKLIST+="*–û—Å—Ç–∞–ª–æ—Å—å 2 –Ω–µ–¥–µ–ª–∏*\n\n"
            CHECKLIST+="‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã\n"
            CHECKLIST+="‚Ä¢ –ò–∑—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥–æ—Ä–æ–¥–µ\n"
            CHECKLIST+="‚Ä¢ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏\n"
            CHECKLIST+="‚Ä¢ –ö—É–ø–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –≤–µ—â–∏\n"
            CHECKLIST+="‚Ä¢ –£–≤–µ–¥–æ–º–∏—Ç—å –Ω–∞ —Ä–∞–±–æ—Ç–µ\n"
          else
            CHECKLIST+="*–ï—â–µ –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏*\n\n"
            CHECKLIST+="‚Ä¢ –ö—É–ø–∏—Ç—å –±–∏–ª–µ—Ç—ã\n"
            CHECKLIST+="‚Ä¢ –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∂–∏–ª—å–µ\n"
            CHECKLIST+="‚Ä¢ –°–æ—Å—Ç–∞–≤–∏—Ç—å –æ–±—â–∏–π –ø–ª–∞–Ω\n"
            CHECKLIST+="‚Ä¢ –ù–∞—á–∞—Ç—å –æ—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å –¥–µ–Ω—å–≥–∏\n"
            CHECKLIST+="‚Ä¢ –ò–∑—É—á–∏—Ç—å –±–∞–∑–æ–≤—ã–µ —Ñ—Ä–∞–∑—ã –Ω–∞ –º–µ—Å—Ç–Ω–æ–º —è–∑—ã–∫–µ\n"
          fi
          
          echo "checklist<<EOF" >> $GITHUB_OUTPUT
          echo -e "$CHECKLIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ Telegram
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            *–ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï –û –ü–û–ï–ó–î–ö–ï*
            
            üóìÔ∏è *–î–∞—Ç–∞ –ø–æ–µ–∑–¥–∫–∏:* ${{ steps.days_left.outputs.travel_date }}
            ‚è≥ *–û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π:* ${{ steps.days_left.outputs.days_left }}
            üéØ *–ü—É–Ω–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è:* ${{ github.event.inputs.destination }}
            
            ${{ steps.checklist.outputs.checklist }}
            
            {{ steps.destination_weather.outputs.dest_temp }}¬∞C" != "" }}
            *–ü–æ–≥–æ–¥–∞ –≤ ${{ github.event.inputs.destination }} —Å–µ–π—á–∞—Å:*
            ‚Ä¢ –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${{ steps.destination_weather.outputs.dest_temp }}¬∞C
            ‚Ä¢ –£—Å–ª–æ–≤–∏—è: ${{ steps.destination_weather.outputs.dest_conditions }}
            ‚Ä¢ –í–ª–∞–∂–Ω–æ—Å—Ç—å: ${{ steps.destination_weather.outputs.dest_humidity }}%
            {{ end }}
            
            *–ù–µ –∑–∞–±—É–¥—å—Ç–µ:*
            ‚Ä¢ –°–æ–æ–±—â–∏—Ç—å —Ä–æ–¥–Ω—ã–º –æ –ø–æ–µ–∑–¥–∫–µ
            ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
            ‚Ä¢ –°–¥–µ–ª–∞—Ç—å —Å—Ç—Ä–∞—Ö–æ–≤–∫—É
            
            –•–æ—Ä–æ—à–µ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏! üöÄ
          parse_mode: markdown
