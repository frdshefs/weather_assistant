name: –ù–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –æ –ø–æ–≥–æ–¥–µ

on:
  schedule:
    # –ö–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 19:00
    - cron: '0 19 * * 0'
  workflow_dispatch:

jobs:
  weekly-report:
    runs-on: ubuntu-latest
    steps:
      - name: –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        uses: actions/checkout@v4

      - name: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é
        id: analyze_history
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏—Å—Ç–æ—Ä–∏—è
          if [ ! -f "weather_history.json" ]; then
            echo "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞" >> $GITHUB_STEP_SUMMARY
            echo "has_data=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # –ß–∏—Ç–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
          HISTORY_COUNT=$(jq -r '.history | length' weather_history.json)
          if [ $HISTORY_COUNT -eq 0 ]; then
            echo "has_data=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É
          TEMPS=$(jq -r '.history[].temperature | tonumber' weather_history.json)
          
          # –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω—é—é
          TOTAL=0
          COUNT=0
          MAX=-100
          MIN=100
          
          for temp in $TEMPS; do
            TOTAL=$(echo "$TOTAL + $temp" | bc)
            COUNT=$((COUNT + 1))
            if (( $(echo "$temp > $MAX" | bc -l) )); then
              MAX=$temp
            fi
            if (( $(echo "$temp < $MIN" | bc -l) )); then
              MIN=$temp
            fi
          done
          
          AVG=$(echo "scale=1; $TOTAL / $COUNT" | bc)
          
          echo "has_data=true" >> $GITHUB_OUTPUT
          echo "avg_temp=$AVG" >> $GITHUB_OUTPUT
          echo "max_temp=$MAX" >> $GITHUB_OUTPUT
          echo "min_temp=$MIN" >> $GITHUB_OUTPUT
          echo "days_count=$COUNT" >> $GITHUB_OUTPUT

      - name: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
        if: steps.analyze_history.outputs.has_data == 'true'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            *–ù–ï–î–ï–õ–¨–ù–´–ô –û–¢–ß–ï–¢ –û –ü–û–ì–û–î–ï* üìä
            
            –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ ${{ steps.analyze_history.outputs.days_count }} –¥–Ω–µ–π:
            
            *–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:*
            ‚Ä¢ –°—Ä–µ–¥–Ω—è—è: ${{ steps.analyze_history.outputs.avg_temp }}¬∞C
            ‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è: ${{ steps.analyze_history.outputs.max_temp }}¬∞C
            ‚Ä¢ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è: ${{ steps.analyze_history.outputs.min_temp }}¬∞C
            
            *–ü–µ—Ä–∏–æ–¥:* —Å $(date -d "7 days ago" +"%d.%m") –ø–æ $(date +"%d.%m.%Y")
            
            *–ê–Ω–∞–ª–∏–∑:*
            ${{ steps.analyze_history.outputs.avg_temp > 20 && '‚Ä¢ –ë—ã–ª–∞ —Ç–µ–ø–ª–∞—è –Ω–µ–¥–µ–ª—è üåû' || '' }}
            ${{ steps.analyze_history.outputs.avg_temp < 10 && steps.analyze_history.outputs.avg_temp > 0 && '‚Ä¢ –ë—ã–ª–∞ –ø—Ä–æ—Ö–ª–∞–¥–Ω–∞—è –Ω–µ–¥–µ–ª—è üçÇ' || '' }}
            ${{ steps.analyze_history.outputs.avg_temp < 0 && '‚Ä¢ –ë—ã–ª–∞ —Ö–æ–ª–æ–¥–Ω–∞—è –Ω–µ–¥–µ–ª—è ‚õÑ' || '' }}
            
            *–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –Ω–µ–¥–µ–ª—é:*
            ${{ steps.analyze_history.outputs.avg_temp > 20 && '‚Ä¢ –ì–æ—Ç–æ–≤—å—Ç–µ –ª–µ—Ç–Ω–∏–µ –≤–µ—â–∏! üëï' || '' }}
            ${{ steps.analyze_history.outputs.avg_temp < 10 && '‚Ä¢ –ù–µ –∑–∞–±—É–¥—å—Ç–µ —Ç–µ–ø–ª—É—é –æ–¥–µ–∂–¥—É! üß•' || '' }}
            
            –î–∞–Ω–Ω—ã–µ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 7:00.
            
            –•–æ—Ä–æ—à–µ–π –Ω–µ–¥–µ–ª–∏! üåà
          parse_mode: markdown

      - name: –°–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
        if: steps.analyze_history.outputs.has_data == 'false'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            *–ù–ï–î–ï–õ–¨–ù–´–ô –û–¢–ß–ï–¢ –û –ü–û–ì–û–î–ï* üìä
            
            –ü–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
            
            *–ß—Ç–æ –¥–µ–ª–∞—Ç—å:*
            1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã
            2. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π
            3. –û—Ç—á–µ—Ç –ø–æ—è–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            
            *–ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å:*
            –í —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ ‚Üí Actions ‚Üí "–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã" ‚Üí Run workflow
            
            –°–∫–æ—Ä–æ –±—É–¥—É—Ç –¥–∞–Ω–Ω—ã–µ! ‚è≥
          parse_mode: markdown
