name: ÐÐµÐ´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð¾ Ð¿Ð¾Ð³Ð¾Ð´Ðµ

on:
  schedule:
    - cron: '0 19 * * 0'  # ÐšÐ°Ð¶Ð´Ð¾Ðµ Ð²Ð¾ÑÐºÑ€ÐµÑÐµÐ½ÑŒÐµ Ð² 19:00
  workflow_dispatch:

jobs:
  weekly-report:
    runs-on: ubuntu-latest
    steps:
      - name: Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹
        uses: actions/checkout@v4

      - name: Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑƒÑ‚Ð¸Ð»Ð¸Ñ‚Ñ‹
        run: sudo apt-get update && sudo apt-get install -y jq bc

      - name: ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ
        id: analyze_history
        run: |
          if [ ! -f "weather_history.json" ]; then
            echo "has_data=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          COUNT=$(jq '.history | length' weather_history.json)
          if [ "$COUNT" -eq 0 ]; then
            echo "has_data=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          AVG_TEMP=$(jq '[.history[].temp | tonumber] | add / length' weather_history.json)
          MAX_TEMP=$(jq '[.history[].temp | tonumber] | max' weather_history.json)
          MIN_TEMP=$(jq '[.history[].temp | tonumber] | min' weather_history.json)
          
          echo "has_data=true" >> $GITHUB_OUTPUT
          echo "avg_temp=$AVG_TEMP" >> $GITHUB_OUTPUT
          echo "max_temp=$MAX_TEMP" >> $GITHUB_OUTPUT
          echo "min_temp=$MIN_TEMP" >> $GITHUB_OUTPUT
          echo "days_count=$COUNT" >> $GITHUB_OUTPUT

      - name: ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚
        if: steps.analyze_history.outputs.has_data == 'true'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ðŸ“Š ÐÐ•Ð”Ð•Ð›Ð¬ÐÐ«Ð™ ÐžÐ¢Ð§Ð•Ð¢ Ðž ÐŸÐžÐ“ÐžÐ”Ð• Ð’ ÐšÐÐ—ÐÐÐ˜

            Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð·Ð° ${{ steps.analyze_history.outputs.days_count }} Ð´Ð½ÐµÐ¹:
            â€¢ Ð¡Ñ€ÐµÐ´Ð½ÑÑ Ñ‚ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð°: ${{ steps.analyze_history.outputs.avg_temp }}Â°C
            â€¢ ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ: ${{ steps.analyze_history.outputs.max_temp }}Â°C
            â€¢ ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ: ${{ steps.analyze_history.outputs.min_temp }}Â°C

            ÐŸÐµÑ€Ð¸Ð¾Ð´: Ñ $(date -d "7 days ago" +"%d.%m") Ð¿Ð¾ $(date +"%d.%m.%Y")

            Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ñ Ð½Ð° ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÑƒÑŽ Ð½ÐµÐ´ÐµÐ»ÑŽ:
            ${{ steps.analyze_history.outputs.avg_temp > 20 && 'â€¢ Ð“Ð¾Ñ‚Ð¾Ð²ÑŒÑ‚Ðµ Ð»ÐµÑ‚Ð½Ð¸Ðµ Ð²ÐµÑ‰Ð¸! ðŸ‘•' || '' }}
            ${{ steps.analyze_history.outputs.avg_temp < 10 && 'â€¢ ÐÐµ Ð·Ð°Ð±ÑƒÐ´ÑŒÑ‚Ðµ Ñ‚ÐµÐ¿Ð»ÑƒÑŽ Ð¾Ð´ÐµÐ¶Ð´Ñƒ! ðŸ§¥' || '' }}

            Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÑŽÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ.

            Ð¥Ð¾Ñ€Ð¾ÑˆÐµÐ¹ Ð½ÐµÐ´ÐµÐ»Ð¸! ðŸŒˆ
          parse_mode: HTML

      - name: Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ÐµÑÐ»Ð¸ Ð½ÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…
        if: steps.analyze_history.outputs.has_data == 'false'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ðŸ“Š ÐÐ•Ð”Ð•Ð›Ð¬ÐÐ«Ð™ ÐžÐ¢Ð§Ð•Ð¢ Ðž ÐŸÐžÐ“ÐžÐ”Ð•

            ÐŸÐ¾ÐºÐ° Ð½ÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°.

            Ð§Ñ‚Ð¾ Ð´ÐµÐ»Ð°Ñ‚ÑŒ:
            1. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ "Ð•Ð¶ÐµÐ´Ð½ÐµÐ²Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾Ð³Ð½Ð¾Ð· Ð¿Ð¾Ð³Ð¾Ð´Ñ‹"
            2. ÐŸÐ¾Ð´Ð¾Ð¶Ð´Ð¸Ñ‚Ðµ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð´Ð½ÐµÐ¹
            3. ÐžÑ‚Ñ‡ÐµÑ‚ Ð¿Ð¾ÑÐ²Ð¸Ñ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸

            ÐšÐ°Ðº Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ:
            Actions â†’ "Ð•Ð¶ÐµÐ´Ð½ÐµÐ²Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾Ð³Ð½Ð¾Ð· Ð¿Ð¾Ð³Ð¾Ð´Ñ‹" â†’ Run workflow

            Ð¡ÐºÐ¾Ñ€Ð¾ Ð±ÑƒÐ´ÑƒÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ! â³
          parse_mode: HTML
