name: –ï–∂–µ—á–∞—Å–Ω–∞—è –ø–æ–≥–æ–¥–∞

on:
  schedule:
    # –ö–∞–∂–¥—ã–π —á–∞—Å (–≤ 0 –º–∏–Ω—É—Ç –∫–∞–∂–¥–æ–≥–æ —á–∞—Å–∞)
    - cron: '0 * * * *'
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  send-hourly-weather:
    runs-on: ubuntu-latest
    steps:
      - name: –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        uses: actions/checkout@v4

      - name: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–≥–æ–¥—É
        id: get_weather
        env:
          VC_API_KEY: ${{ secrets.VC_API_KEY }}
        run: |
          # –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫ Visual Crossing API
          RESPONSE=$(curl -s "https://weather.visualcrossing.com/VisualCrossingWebServices/rest/services/timeline/kazan?unitGroup=metric&include=current&key=$VC_API_KEY&contentType=json&lang=ru")
          
          # –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ
          TEMP=$(echo "$RESPONSE" | jq -r '.currentConditions.temp')
          FEELS_LIKE=$(echo "$RESPONSE" | jq -r '.currentConditions.feelslike')
          CONDITIONS=$(echo "$RESPONSE" | jq -r '.currentConditions.conditions')
          HUMIDITY=$(echo "$RESPONSE" | jq -r '.currentConditions.humidity')
          WIND_SPEED=$(echo "$RESPONSE" | jq -r '.currentConditions.windspeed')
          WIND_GUST=$(echo "$RESPONSE" | jq -r '.currentConditions.windgust // "N/A"')
          UVINDEX=$(echo "$RESPONSE" | jq -r '.currentConditions.uvindex // "N/A"')
          VISIBILITY=$(echo "$RESPONSE" | jq -r '.currentConditions.visibility // "N/A"')
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —ç–º–æ–¥–∑–∏
          case "$CONDITIONS" in
            *Clear*|*Sunny*)
              EMOJI="‚òÄÔ∏è"
              ;;
            *Partially*|*Cloud*)
              EMOJI="‚õÖ"
              ;;
            *Rain*|*Drizzle*)
              EMOJI="üåßÔ∏è"
              ;;
            *Snow*)
              EMOJI="‚ùÑÔ∏è"
              ;;
            *Fog*|*Mist*)
              EMOJI="üå´Ô∏è"
              ;;
            *Thunder*)
              EMOJI="‚õàÔ∏è"
              ;;
            *)
              EMOJI="üå§Ô∏è"
              ;;
          esac
          
          # –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è
          CURRENT_TIME=$(date +"%H:%M")
          CURRENT_DATE=$(date +"%d.%m.%Y")
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
          echo "temp=$TEMP" >> $GITHUB_OUTPUT
          echo "feels_like=$FEELS_LIKE" >> $GITHUB_OUTPUT
          echo "conditions=$CONDITIONS" >> $GITHUB_OUTPUT
          echo "humidity=$HUMIDITY" >> $GITHUB_OUTPUT
          echo "wind_speed=$WIND_SPEED" >> $GITHUB_OUTPUT
          echo "wind_gust=$WIND_GUST" >> $GITHUB_OUTPUT
          echo "uvindex=$UVINDEX" >> $GITHUB_OUTPUT
          echo "visibility=$VISIBILITY" >> $GITHUB_OUTPUT
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT
          echo "time=$CURRENT_TIME" >> $GITHUB_OUTPUT
          echo "date=$CURRENT_DATE" >> $GITHUB_OUTPUT

      - name: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ${{ steps.get_weather.outputs.emoji }} –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–û–ì–û–î–´
            
            –í—Ä–µ–º—è: ${{ steps.get_weather.outputs.time }} (${{ steps.get_weather.outputs.date }})
            
            –°–µ–π—á–∞—Å –≤ –ö–∞–∑–∞–Ω–∏:
            ‚Ä¢ –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${{ steps.get_weather.outputs.temp }}¬∞C
            ‚Ä¢ –û—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫: ${{ steps.get_weather.outputs.feels_like }}¬∞C
            ‚Ä¢ –ü–æ–≥–æ–¥–∞: ${{ steps.get_weather.outputs.conditions }}
            ‚Ä¢ –í–ª–∞–∂–Ω–æ—Å—Ç—å: ${{ steps.get_weather.outputs.humidity }}%
            ‚Ä¢ –í–µ—Ç–µ—Ä: ${{ steps.get_weather.outputs.wind_speed }} –º/—Å
            
            –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:
            ‚Ä¢ –ü–æ—Ä—ã–≤—ã –≤–µ—Ç—Ä–∞: ${{ steps.get_weather.outputs.wind_gust }} –º/—Å
            ‚Ä¢ –£–§-–∏–Ω–¥–µ–∫—Å: ${{ steps.get_weather.outputs.uvindex }}
            ‚Ä¢ –í–∏–¥–∏–º–æ—Å—Ç—å: ${{ steps.get_weather.outputs.visibility }} –∫–º
            
            –°–ª–µ–¥—É—é—â–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —á–∞—Å ‚è∞
          parse_mode: HTML
