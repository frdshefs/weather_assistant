name: –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ –ø–æ–≥–æ–¥–Ω—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

on:
  schedule:
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 3 —á–∞—Å–∞
    - cron: '0 */3 * * *'
  workflow_dispatch:

jobs:
  check-alerts:
    runs-on: ubuntu-latest
    steps:
      - name: –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        uses: actions/checkout@v4

      - name: –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–ø–∞—Å–Ω—É—é –ø–æ–≥–æ–¥—É
        id: check_danger
        env:
          VC_API_KEY: ${{ secrets.VC_API_KEY }}
        run: |
          # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–≥–æ–¥—É
          RESPONSE=$(curl -s "https://weather.visualcrossing.com/VisualCrossingWebServices/rest/services/timeline/kazan?unitGroup=metric&include=current&key=$VC_API_KEY&contentType=json")

          TEMP=$(echo "$RESPONSE" | jq -r '.currentConditions.temp')
          WIND_SPEED=$(echo "$RESPONSE" | jq -r '.currentConditions.windspeed')
          CONDITIONS=$(echo "$RESPONSE" | jq -r '.currentConditions.conditions')

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–ø–∞—Å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
          ALERT=""
          HAS_ALERT="false"

          if (( $(echo "$TEMP >= 35" | bc -l) )); then
            ALERT+="*–ê–Ω–æ–º–∞–ª—å–Ω–∞—è –∂–∞—Ä–∞!* üî•\n–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${TEMP}¬∞C\n\n"
            HAS_ALERT="true"
          fi

          if (( $(echo "$TEMP <= -20" | bc -l) )); then
            ALERT+="*–°–∏–ª—å–Ω—ã–π –º–æ—Ä–æ–∑!* ‚ùÑÔ∏è\n–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${TEMP}¬∞C\n\n"
            HAS_ALERT="true"
          fi

          if (( $(echo "$WIND_SPEED >= 15" | bc -l) )); then
            ALERT+="*–°–∏–ª—å–Ω—ã–π –≤–µ—Ç–µ—Ä!* üí®\n–°–∫–æ—Ä–æ—Å—Ç—å: ${WIND_SPEED} –º/—Å\n\n"
            HAS_ALERT="true"
          fi

          if [[ "$CONDITIONS" == *"Thunderstorm"* ]]; then
            ALERT+="*–ì—Ä–æ–∑–∞!* ‚õàÔ∏è\n$CONDITIONS\n\n"
            HAS_ALERT="true"
          fi

          if [[ "$CONDITIONS" == *"Snow"* ]] && (( $(echo "$TEMP <= -10" | bc -l) )); then
            ALERT+="*–°–∏–ª—å–Ω—ã–π —Å–Ω–µ–≥–æ–ø–∞–¥!* üö®\n$CONDITIONS\n\n"
            HAS_ALERT="true"
          fi

          echo "alert_message<<EOF" >> $GITHUB_OUTPUT
          echo "$ALERT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "has_alert=$HAS_ALERT" >> $GITHUB_OUTPUT

      - name: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
        if: steps.check_danger.outputs.has_alert == 'true'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            üö® *–ü–û–ì–û–î–ù–û–ï –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï –î–õ–Ø –ö–ê–ó–ê–ù–ò*

            ${{ steps.check_danger.outputs.alert_message }}

            *–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:*
            ‚Ä¢ –û—Å—Ç–∞–≤–∞–π—Ç–µ—Å—å –¥–æ–º–∞, –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ
            ‚Ä¢ –û–¥–µ–Ω—å—Ç–µ—Å—å –ø–æ –ø–æ–≥–æ–¥–µ
            ‚Ä¢ –ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã –Ω–∞ –¥–æ—Ä–æ–≥–∞—Ö

            *–í—Ä–µ–º—è:* $(date +"%H:%M %d.%m.%Y")

            –ë–µ—Ä–µ–≥–∏—Ç–µ —Å–µ–±—è! üôè
          parse_mode: markdown

      - name: –°–æ–æ–±—â–∞–µ–º, —á—Ç–æ –≤—Å—ë —Å–ø–æ–∫–æ–π–Ω–æ
        if: steps.check_danger.outputs.has_alert == 'false' && github.event_name == 'workflow_dispatch'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ‚úÖ *–í–°–Å –°–ü–û–ö–û–ô–ù–û –í –ö–ê–ó–ê–ù–ò*

            –û–ø–∞—Å–Ω—ã—Ö –ø–æ–≥–æ–¥–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ.
            –¢–µ–∫—É—â–∞—è –ø–æ–≥–æ–¥–∞ –±–µ–∑–æ–ø–∞—Å–Ω–∞ –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–ª.

            *–í—Ä–µ–º—è:* $(date +"%H:%M %d.%m.%Y")

            –•–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è! üå§Ô∏è
          parse_mode: markdown
